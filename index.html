<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CannaTracker</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>

  <style>
    .smoke {
      position: absolute;
      width: 0;
      height: 0;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.6);
      animation: smokeAnimation 3s forwards;
      z-index: 100;
    }

    @keyframes smokeAnimation {
      0% {
        width: 10px;
        height: 10px;
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      100% {
        width: 50px;
        height: 50px;
        opacity: 0;
        transform: translateY(-200px) scale(2);
      }
    }

    .twirl {
      animation: twirl 0.6s ease-in-out;
    }

    @keyframes twirl {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.2); }
      100% { transform: rotate(360deg) scale(1); }
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen px-4 py-8">

  <!-- Insert autocomplete list -->
  <datalist id="strain-suggestions"></datalist>

  <!-- Add image upload input -->
  <script>
    const storage = firebase.storage();
    const staticStrains = ["OG Kush", "Blue Dream", "Girl Scout Cookies", "Granddaddy Purple", "White Widow", "Sour Diesel"];
    const datalist = document.getElementById('strain-suggestions');

    function loadSuggestions() {
      staticStrains.forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        datalist.appendChild(option);
      });
      db.collection('strains').get().then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          if (!staticStrains.includes(data.name)) {
            const opt = document.createElement('option');
            opt.value = data.name;
            datalist.appendChild(opt);
          }
        });
      });
    }
    loadSuggestions();
  </script>

  <script>
    function animateStar(star) {
      star.classList.add('twirl');
      setTimeout(() => star.classList.remove('twirl'), 600);
    }

    async function handleAddStrain(event) {
      event.preventDefault();
      const strainName = nameInput.value.trim();
      const description = document.getElementById('description').value.trim();
      const notes = document.getElementById('notes').value.trim();
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.click();

      fileInput.onchange = async () => {
        const file = fileInput.files[0];
        const strainData = {
          name: strainName,
          type: selectedType,
          description,
          notes,
          rating: 0
        };

        if (file) {
          const storageRef = storage.ref().child(`strain-images/${strainName}-${Date.now()}`);
          await storageRef.put(file);
          strainData.imageUrl = await storageRef.getDownloadURL();
        }

        db.collection('strains').add(strainData).then(() => {
          alert('Strain added successfully!');
          triggerSmokeAnimation();
          nameInput.value = '';
          document.getElementById('description').value = '';
          document.getElementById('notes').value = '';
          selectedType = '';
          document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('bg-green-500'));
        }).catch((error) => {
          console.error("Error adding strain: ", error);
        });
      }
    }

    function renderList() {
      list.innerHTML = '';
      const filtered = strains.filter(({ data }) => {
        if (!selectedType) return true;
        return data.type === selectedType;
      });

      const sorted = filtered.sort((a, b) =>
        ascending ? a.data.name.localeCompare(b.data.name) : b.data.name.localeCompare(a.data.name)
      );

      sorted.forEach(({ id, data }) => {
        const div = document.createElement('div');
        div.className = 'bg-gray-700 p-4 rounded hover:bg-gray-600 transition cursor-pointer';
        let imageTag = data.imageUrl ? `<img src="${data.imageUrl}" class="mb-2 rounded w-full h-40 object-cover" />` : '';
        div.innerHTML = `
          ${imageTag}
          <h3 class="text-xl font-bold text-green-400">${data.name}</h3>
          <p class="italic text-sm text-gray-300">${data.type}</p>
          <p class="mt-2 text-white">${data.description}</p>
          <p class="mt-2 text-sm italic text-gray-400">${data.notes || ''}</p>
          <div class="flex space-x-1 mt-2">
            ${[1, 2, 3, 4, 5].map(i => `<span class="star text-2xl cursor-pointer" data-doc="${id}" data-rating="${i}">â˜…</span>`).join('')}
          </div>
          <button onclick="openDetailsModal('${data.name}', '${id}')" class="mt-2 bg-blue-500 text-white py-1 px-3 rounded">Details</button>
          <button onclick="openNotesModal('${data.name}', '${id}')" class="mt-2 bg-yellow-500 text-white py-1 px-3 rounded">Add Notes</button>
        `;
        const stars = div.querySelectorAll('.star');
        stars.forEach(star => {
          const r = parseInt(star.dataset.rating);
          star.style.color = r <= data.rating ? 'gold' : 'black';
          star.addEventListener('click', async (e) => {
            e.stopPropagation();
            await db.collection('strains').doc(id).update({ rating: r });
            animateStar(star);
            renderList();
          });
        });
        list.appendChild(div);
      });
    }
  </script>
</body>
</html>
