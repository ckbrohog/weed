<!-- JUST HEAD PART SHOWN FOR LENGTH -->
<!-- ...your head and form stay the same... -->

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBeR5kfsutaflDkMqDQJgU4lGzeXR3VuTk",
    authDomain: "weed-a53a5.firebaseapp.com",
    projectId: "weed-a53a5",
    storageBucket: "weed-a53a5.appspot.com",
    messagingSenderId: "715010576158",
    appId: "1:715010576158:web:59a2064fb4ca7ea8f8030f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const list = document.getElementById('strain-list');
  const searchBar = document.getElementById('search-bar');
  const dropdown = document.getElementById('dropdown');
  const sortButton = document.getElementById('sort-button');
  const nameInput = document.getElementById('name');
  const notesModal = document.getElementById('notes-modal');
  const notesTextarea = document.getElementById('notes-textarea');
  const detailsModal = document.getElementById('details-modal');
  const detailsStrainName = document.getElementById('details-strain-name');
  const detailsGrowKnowledge = document.getElementById('details-grow-knowledge');
  const filterTypeSelect = document.getElementById('filter-type');
  const indicaBtn = document.getElementById('indica-btn');
  const sativaBtn = document.getElementById('sativa-btn');
  const hybridBtn = document.getElementById('hybrid-btn');
  let ascending = true;
  let strains = [];
  let selectedType = '';

  db.collection('strains').onSnapshot(snapshot => {
    strains = [];
    snapshot.forEach(doc => strains.push({ id: doc.id, data: doc.data() }));
    renderList();
  });

  function renderList() {
    list.innerHTML = '';
    const filteredStrains = strains.filter(({ data }) => {
      if (!selectedType) return true;
      return data.type === selectedType;
    });

    const sorted = filteredStrains.sort((a, b) =>
      ascending ? a.data.name.localeCompare(b.data.name) : b.data.name.localeCompare(a.data.name)
    );

    sorted.forEach(({ id, data }) => {
      const div = document.createElement('div');
      div.className = 'bg-gray-700 p-4 rounded hover:bg-gray-600 transition cursor-pointer';
      div.innerHTML = `
        <h3 class="text-xl font-bold text-green-400">${data.name}</h3>
        <p class="italic text-sm text-gray-300">${data.type}</p>
        <p class="mt-2 text-white">${data.description}</p>
        <p class="mt-2 text-sm italic text-gray-400">${data.notes || ''}</p>
        <div class="flex space-x-1 mt-2">
          ${[1, 2, 3, 4, 5].map(i =>
            `<span class="star text-2xl cursor-pointer" data-doc="${id}" data-rating="${i}">★</span>`
          ).join('')}
        </div>
        <button onclick="openDetailsModal('${data.name}', '${id}')" class="mt-2 bg-blue-500 text-white py-1 px-3 rounded">Details</button>
        <button onclick="openNotesModal('${data.name}', '${id}')" class="mt-2 bg-yellow-500 text-white py-1 px-3 rounded">Add Notes</button>
      `;

      const stars = div.querySelectorAll('.star');
      stars.forEach(star => {
        const r = parseInt(star.dataset.rating);
        star.style.color = r <= data.rating ? 'gold' : 'black';
        star.addEventListener('click', async (e) => {
          e.stopPropagation();
          await db.collection('strains').doc(id).update({ rating: r });
        });
      });

      list.appendChild(div);
    });
  }

  function openDetailsModal(strainName, strainId) {
    detailsStrainName.textContent = strainName;
    detailsGrowKnowledge.textContent = getStrainData(strainName).growKnowledge;
    detailsModal.classList.remove('hidden');
    detailsModal.classList.add('flex');
  }

  function closeDetailsModal() {
    detailsModal.classList.add('hidden');
    detailsModal.classList.remove('flex');
  }

  function openNotesModal(strainName, strainId) {
    document.getElementById('notes-strain-name').textContent = strainName;
    notesModal.classList.remove('hidden');
    notesModal.classList.add('flex');
    notesTextarea.value = '';
    document.getElementById('save-notes').onclick = () => saveNotes(strainId);
  }

  function closeNotesModal() {
    notesModal.classList.add('hidden');
    notesModal.classList.remove('flex');
  }

  async function saveNotes(strainId) {
    const notes = notesTextarea.value.trim();
    if (notes) {
      await db.collection('strains').doc(strainId).update({ notes });
      closeNotesModal();
    } else {
      alert("Please enter some notes.");
    }
  }

  function getStrainData(name) {
    const strainKnowledge = {
      "Blue Sunset Sherbet": "...",
      "Cookies Kush": "...",
      "OG Kush": "...",
      "Tangie": "...",
      "Whale Breath": "..."
    };
    return {
      name: name,
      growKnowledge: strainKnowledge[name] || "No details available."
    };
  }

  // Fix: Correct template string
  sortButton.addEventListener('click', () => {
    ascending = !ascending;
    sortButton.textContent = `Sort: ${ascending ? 'A–Z' : 'Z–A'}`;
    renderList();
  });

  filterTypeSelect.addEventListener('change', () => {
    selectedType = filterTypeSelect.value;
    renderList();
  });

  document.querySelectorAll('.type-btn').forEach(button => {
    button.addEventListener('click', () => {
      document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('bg-green-500'));
      button.classList.add('bg-green-500');
      selectedType = button.textContent;
    });
  });

  function handleAddStrain(event) {
    event.preventDefault();
    const strainName = nameInput.value.trim();
    const description = document.getElementById('description').value.trim();
    const notes = document.getElementById('notes').value.trim();

    if (!strainName || !description || !selectedType) {
      alert("Please fill in all fields and select a strain type.");
      return;
    }

    db.collection('strains').add({
      name: strainName,
      type: selectedType,
      description,
      notes,
      rating: 0
    }).then(() => {
      alert('Strain added successfully!');
      triggerSmokeAnimation();
      nameInput.value = '';
      document.getElementById('description').value = '';
      document.getElementById('notes').value = '';
      selectedType = '';
      document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('bg-green-500'));
    }).catch((error) => {
      console.error("Error adding strain: ", error);
    });
  }

  function triggerSmokeAnimation() {
    const smokeElement = document.createElement('div');
    smokeElement.className = 'smoke';
    document.body.appendChild(smokeElement);
    setTimeout(() => smokeElement.remove(), 3000);
  }

  // Fix: use backticks for URL strings
  document.getElementById('lookup-leafly').addEventListener('click', () => {
    const query = nameInput.value.trim();
    if (!query) return alert('Enter a strain name to look up.');
    window.open(`https://www.leafly.com/search?q=${encodeURIComponent(query)}`, '_blank');
  });

  document.getElementById('lookup-seedsman').addEventListener('click', () => {
    const query = nameInput.value.trim();
    if (!query) return alert('Enter a strain name to look up.');
    window.open(`https://www.seedsman.com/search?query=${encodeURIComponent(query)}`, '_blank');
  });

  document.getElementById('find-near-me').addEventListener('click', () => {
    window.open('https://www.google.com/maps/search/weed+dispensaries+near+me', '_blank');
  });
</script>
