<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBeR5kfsutaflDkMqDQJgU4lGzeXR3VuTk",
    authDomain: "weed-a53a5.firebaseapp.com",
    projectId: "weed-a53a5",
    storageBucket: "weed-a53a5.appspot.com",
    messagingSenderId: "715010576158",
    appId: "1:715010576158:web:59a2064fb4ca7ea8f8030f",
    measurementId: "G-JDZX4R9XM2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const form = document.getElementById('strain-form');
  const list = document.getElementById('strain-list');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = form.name.value;
    const type = form.type.value;
    const description = form.description.value;

    await db.collection('strains').add({ name, type, description });
    form.reset();
  });

  // Real-time list
  db.collection('strains').orderBy('name').onSnapshot((snapshot) => {
    list.innerHTML = '';
    snapshot.forEach(doc => {
      const { name, type, description } = doc.data();
      const searchUrl = `https://www.leafly.com/search?q=${encodeURIComponent(name)}`;
      const div = document.createElement('div');
      div.className = 'bg-gray-700 p-4 rounded';
      div.innerHTML = `
        <h3 class="text-xl font-bold text-green-400">${name}</h3>
        <p class="italic text-sm text-gray-300">${type}</p>
        <p class="mt-2 text-white">${description}</p>
        <a href="${searchUrl}" target="_blank" class="inline-block mt-3 bg-green-500 hover:bg-green-600 text-black font-bold py-1 px-3 rounded">
          üîç Look up on Leafly
        </a>
      `;
      list.appendChild(div);
    });
  });

  // Strain lookup
  document.getElementById('lookup-btn').addEventListener('click', async () => {
    const input = document.getElementById('lookup-input').value.trim();
    const result = document.getElementById('lookup-result');
    result.innerHTML = "Loading...";

    if (!input) return (result.innerHTML = "Please enter a strain name.");

    try {
      const res = await fetch(`https://www.cannabisreports.com/api/v1.0/strains/search/${encodeURIComponent(input)}`);
      const data = await res.json();

      if (data.data && data.data.length > 0) {
        const strain = data.data[0];

        // Autofill the form
        document.getElementById('name').value = strain.name;
        document.getElementById('type').value = strain.race;
        document.getElementById('description').value = strain.desc || "No description available.";

        // Generate a Google Image Search link for Leafly preview
        const imageQuery = `site:leafly.com ${strain.name}`;
        const imageSearchUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(imageQuery)}`;
        const imageThumb = `https://source.unsplash.com/featured/?cannabis,${encodeURIComponent(strain.name)}`; // Better fallback

        result.innerHTML = `
          <div class="bg-gray-700 p-4 rounded">
            <h3 class="text-xl font-bold text-green-400">${strain.name}</h3>
            <p class="italic text-sm text-gray-300">Type: ${strain.race}</p>
            <p class="mt-2 mb-4">${strain.desc || 'No description available.'}</p>
            <img src="${imageThumb}" alt="${strain.name} image" class="w-full rounded mb-4" />
            <a href="${imageSearchUrl}" target="_blank" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded">
              üîç View Strain Images
            </a>
          </div>
        `;
      } else {
        const fallbackUrl = `https://www.leafly.com/search?q=${encodeURIComponent(input)}`;
        result.innerHTML = `
          <p>No info found in Cannabis Reports. Try <a href="${fallbackUrl}" target="_blank" class="text-blue-400 underline">Leafly Search</a>.</p>
        `;
      }
    } catch (err) {
      result.innerHTML = "Error fetching data.";
      console.error(err);
    }
  });
</script>
